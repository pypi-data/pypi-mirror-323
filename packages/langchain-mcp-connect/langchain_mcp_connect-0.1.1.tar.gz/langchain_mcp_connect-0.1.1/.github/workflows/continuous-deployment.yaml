# This is a basic workflow to help you get started with Actions
name: Continuous Deployment

# Controls when the action will run. Invokes the workflow on push events but only for the main branch
on:
  workflow_dispatch:

permissions:
  id-token: write # This is required for requesting credentials for trusted publishers
  contents: write # This is required for actions/checkout

jobs:
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    environment: pypi
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          version: 0.5.24

      - name: Set up Python
        run: uv python install

      - name: Build and publish
        run: |
          uv build
          uv publish

      - name: Download all the dists
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Sign the dists with Sigstore
        uses: sigstore/gh-action-sigstore-python@v3.0.0
        with:
          inputs: >-
            ./dist/*.tar.gz
            ./dist/*.whl

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: >-
          gh release create
          "$GITHUB_REF_NAME"
          --repo "$GITHUB_REPOSITORY"
          --notes "langchain-mcp-connect release"

      - name: Upload artifact signatures to GitHub Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        # Upload to GitHub Release using the `gh` CLI.
        # `dist/` contains the built packages, and the
        # sigstore-produced signatures and certificates.
        run: >-
          gh release upload
          "$GITHUB_REF_NAME" dist/**
          --repo "$GITHUB_REPOSITORY"
